---
title: "I Discrimination"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

```{r setup & load data, include=FALSE}
source("_helpers.R")
run_n_check <- T
```


```{r load}
# pays 
c2t_B1 <- read_csv(here("Data", "code2txt", "NCCR_MMS_codes - B1.csv"))

H9 <- mms_load_data(F) %>% 
  select(H9_1, H9_2, H9_3,
         H9_4, H9_5, H9_6, 
         H9_7, H9_8, H9_9)


# 1.      during education and work
# 2.      in shops, in public and/or during leisure activities
# 3.      in healthcare and care
# 4.      by public authorities
# 5.      on the Internet
# 6.      in another situation or by other persons
# 7.      during the search for a job
# 8.      when applying for an apartment
# -9.      No answer

# 1.      Never
# 2.      Rarely
# 3.      Sometimes
# 4.      Frequently

data_all <- bind_cols(mms_df, H9)  %>%  
  mutate(
    h7 = case_when(
      H7 == "1" ~ "Never",
      H7 == "2" ~ "Rarely",
      H7 == "3" ~ "Sometimes",
      H7 == "4" ~ "Frequently",
      TRUE ~ NA)
  ) %>% 
  left_join(c2t_B1) 

i_df <- data_all %>% 
  select(year:country) 
  
 h9_names <- tibble(
   h9 = c("H9_1", "H9_2", "H9_3", 
   "H9_4", "H9_5", "H9_6",
   "H9_7", "H9_8"), #, "H9_9"),
   descr = c(
     "during education and work",
     "in shops, in public and/or during leisure activities",
     "in healthcare and care",
     "by public authorities",
     "on the internet",
     "in another situation or by other persons",
     "during the search for a job",
     "when applying for an apartment"
   ),
  short_descr = c(
    "education & work",
    "public activities",
    "healthcare & care",
    "public authorities",
    "internet",
    "other situations",
    "search for a job",
    "applying for an apartment")
  )

    
```


```{r wrangle & check}
disy_df <- i_df %>% 
  filter(year >= 2018) %>% 
  filter(!is.na(h7)) %>%
  group_by(year, h7) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(year) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>%
  ungroup() %>% 
  mutate(
    h7 = factor(h7, levels = rev(c("Never", "Rarely", "Sometimes", "Frequently")))
  )

if(run_n_check) {
  disy_df %>% 
    select(year, h7, share, n_y) %>%
    pivot_wider(
      names_from = h7,
      values_from = share
    )
}

ii_df  <- i_df %>% 
  filter(year >= 2024) %>% 
  select(year, weight, country, H9_1:H9_8)

# Calculate the weighted share, including -7 in the total
disr_df  <- ii_df %>%
  # 1. Reshape the 8 columns into a long format (same as before)
  pivot_longer(
    cols = H9_1:H9_8,
    names_to = "question",
    values_to = "response"
  ) %>%
  
  #filter(response %in% c(1,2,-7)) %>%
  
  # 2. Group by each original question column
  group_by(question) %>%
  # 3. Calculate the weighted share of '1's
  summarise(
    n = n(),
    # Numerator: Sum of weights only where the response is 1 (this is unchanged)
    sum_weight_of_1 = sum(weight[response == 1], na.rm = TRUE),
    
    # Denominator: Total sum of weights for ALL responses (1, 2, and -7)
    total_weight = sum(weight, na.rm = TRUE),
    
    # Final calculation
    weighted_share = (sum_weight_of_1 / total_weight) * 100
  ) %>%
  
  # Optional: Arrange the results for clarity
  arrange(question) %>% 
  left_join(h9_names, by = c("question" = "h9")) 

if(run_n_check) {
  disr_df
}

## compute the weighted average also by country
disrc_df  <- ii_df %>%
  # 1. Reshape the 8 columns into a long format (same as before)
  pivot_longer(
    cols = H9_1:H9_8,
    names_to = "question",
    values_to = "response"
  ) %>%
  
  #filter(response %in% c(1,2,-7)) %>%
  
  # 2. Group by each original question column and country
  group_by(country, question) %>%
  # 3. Calculate the weighted share of '1's
  summarise(
    n = n(),
    # Numerator: Sum of weights only where the response is 1 (this is unchanged)
    sum_weight_of_1 = sum(weight[response == 1], na.rm = TRUE),
    
    # Denominator: Total sum of weights for ALL responses (1, 2, and -7)
    total_weight = sum(weight, na.rm = TRUE),
    
    # Final calculation
    weighted_share = (sum_weight_of_1 / total_weight) * 100
  ) %>%
  ungroup %>% 
  filter(!is.na(country)) %>% 
  filter(country != "Other countries") %>% 
  mutate(
    country = fct_reorder(country, weighted_share, .fun = mean)
  ) %>% 
  left_join(h9_names, by = c("question" = "h9")) 
  
if(run_n_check) {
  disrc_df %>% 
    select(country, question, weighted_share) %>%
    pivot_wider(
      names_from = question,
      values_from = weighted_share
    )
}

```



### VIZ

#### 1. main  chart

```{r 1}
p_dis_1 <- disy_df %>% 
  ggplot(aes(x = year, y = share, group = h7)) +
  geom_area(aes(fill = h7), alpha = 1) +
  theme_mms(grid="XY", axis="xy", 
           # grid_col =  scales::alpha("lightgrey", 0.6),
          #  plot_margin = mms_plot_margin_l,
            mms_plot_title = mms_txtbox_plot.title(nrow_txt = 2),
            mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  )  +
  theme(legend.position = "none",
        panel.background = element_rect(fill = NA),  # transparent
        panel.ontop = TRUE,
      #  plot.margin = margin(l = -150,  r = 50, unit = "pt") # hack !!!!!!!!!!!!!!!!!!!!
      #  plot.title.position = "panel"
  ) +
  # remove any scale expansion  
  scale_x_continuous(expand = c(0,0), name = "", breaks = seq(2018, 2024, 2)) +
  # have y scale not start at 0, add unit %
  scale_y_continuous(expand = c(0,0), name = "", 
                     breaks = seq(25, 100, 25),
                     labels = function(x) paste0(x, "%")) +
  labs(
    title = str_c("Discrimination rates remain stable, affecting over half of respondents"),
    subtitle="Experiences of prejudice or discrimination in the last 24 months") +
 # scale_fill_manual(values = nccr_sequential_blue()[c(1,4,7,10)])
  scale_fill_manual(values = c(darken(nccr_bi_colors[10], 0.2), darken(nccr_bi_colors[10], 0),
                               lighten(nccr_bi_colors[9], 0), nccr_bi_colors[13]))

 annot_df <- tibble(
   year = rep(2021, 4),
   share_w = c(27, 62, 86, 98.8),
   txt = c("Never", "Rarely", "Sometimes", "Frequently")
 )   
p_dis_1a <- p_dis_1  +
   geom_richtext(data = annot_df, aes(
     x = year, y = share_w, label = txt, group = 1),
     fill = NA, label.color = NA,# remove background and outline,
     color = "white", size = 3, alpha = 1,
     #fontface = "bold",
     hjust = 0.5, family = mms_base_family
   )
p_dis_1a
```

#### 2.   

```{r 2}

disr_df %<>% 
  mutate(
    # Reorder the 'descr' factor by the 'weighted_share' value for a clean look
    descr_ordered = fct_reorder(descr, weighted_share),
    # Wrap the long text labels to a specific width
    descr_wrapped = str_wrap(descr_ordered, width = 35)
  ) %>% 
  arrange(descr_ordered)


p_dis_2 <- disr_df %>% 
  ggplot(aes(x = weighted_share, y = descr_ordered)) +
  # Create the horizontal "stick" of the lollipop
  geom_segment(
    aes(x = 0, xend = weighted_share, 
        y = descr_ordered, yend = descr_ordered),
    color = nccr_bi_colors[9],
    linewidth = 1,
    alpha = 0.7
  ) +
  # Create the "candy" dot at the end
  geom_point(
    color = nccr_bi_colors[10], # Using one of your nccr_bi_colors
    size = 4,
    alpha = 0.9
  ) +
  # Add the numeric value as a text label next to the dot
  geom_text(
    aes(label = paste0(round(weighted_share, 0), "%")),
    hjust = -0.37, # Position the text slightly to the right of the point
    size = 3,
    nudge_x = 0.1,
    color = nccr_bi_colors[14],
    family = mms_base_family,
    #alpha = 0.7
  ) +
  geom_text(
    aes(x = 0,
        y = descr_ordered,
        label = descr_ordered),
    hjust = 0,
    vjust = 0,
    size = 3,
    nudge_x = 0.1,
    nudge_y = 0.25,
    color = darken(mms_axis_tick_txt_color, 0.2), # "black",
    family = mms_base_family,
    #fontface = "italic",
  ) +
  # Customize labels and theme
  labs(
    title = "Discrimination is more frequent in public life than in institutional settings",
    subtitle = "Discrimination incidents in the last 24 months<br>",
    #x = "Share of Respondents (%)",
    y = ""
  ) +
  # Ensure the x-axis starts at 0 and add some padding for the text labels
  scale_x_continuous(
    limits = c(0, max(disr_df$weighted_share) * 1.13),
    expand = c(0, 0),
    breaks = NULL,
    name = ""
  ) +
  coord_cartesian(clip = "off") + # Allow text to go beyond plot area
  scale_y_discrete(expand = c(0, 0)) +
  theme_mms(
    grid = F, axis = "Y",
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 4),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 3)
  ) +
  theme(
    panel.grid.major.y = element_blank(), # Remove horizontal grid lines for a cleaner look
    panel.grid.minor.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
  #  plot.title.position = "panel"
  )

p_dis_2

```

#### 3.

```{r 3}
disrc_df %<>%
  mutate(
    short_descr = str_wrap(short_descr, width = 10)
  ) 

# Determine the order of countries based on their single highest value
country_order <- disrc_df %>%
  group_by(country) %>%
  summarise(max_share = max(weighted_share, na.rm = TRUE)) %>%
  arrange(max_share) %>% # Arrange from low to high for correct factor ordering
  pull(country)

# Find the midpoint of the data range to use as a threshold
midpoint <- mean(range(disrc_df$weighted_share))


# Determine the order of descr (columns) by their average value across all countries
descr_order <- disrc_df %>%
  group_by(short_descr) %>%
  summarise(avg_share = mean(weighted_share, na.rm = TRUE)) %>%
  arrange(desc(avg_share)) %>% 
  pull(short_descr)


# Prepare the data for plotting
disrc_df %<>%
  mutate(
    # Apply the new order to the country factor
    country = factor(country, levels = country_order),
     # Apply the column order
    short_descr = factor(short_descr, levels = descr_order),
    # Create a clean label for the text
    share_label = round(weighted_share, 1),
    text_color = if_else(weighted_share >= midpoint, "white", "black")
  )

# Create the heatmap plot
p_dis_3 <- disrc_df %>% 
  ggplot(aes(
    x = short_descr, y = country, fill = weighted_share)) +
  # Add the heatmap tiles
  geom_tile(color = "white", linewidth = 0.7) +
  
  # Add the text labels inside the tiles
  geom_text(aes(label = share_label, color = text_color), 
            size = 3.5, family = mms_base_family) +
  
  # Customize the color gradient
  scale_fill_gradient(low = "#f1f1f4", high = "#4a476b", name = "Weighted Share (%)") +
  
  # Clean up the theme and labels
  labs(
    title = "Discrimination in public life primarily affects non-Europeans, while at work or school it is more widespread",
    subtitle = "Share of all respondents who reported discrimination in the past 24 months",
    x = "",
    y = ""
  ) +
  theme_mms(
    grid = F, axis = F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 2),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 1)
  ) +
  theme(
    # Rotate x-axis labels to prevent overlap
    #axis.ticks.x = element_blank(),
    axis.text.x = element_text(
      angle = 45, hjust = 0, vjust = 0, size = 11),
    axis.text.y = element_text(size = 11, hjust = 1),
    legend.position = "none",
   # plot.title.position = "panel"
  ) +
  scale_x_discrete(position = "top") +
  scale_y_discrete(expand = c(0,0)) +
  scale_color_identity() 

p_dis_3

```

#### patch

```{r patch}


# top_row <- p_dis_1a + p_dis_2 + plot_layout(widths = c(1, 1.5))
# patchwork <- top_row / p_dis_3 + plot_layout(heights = c(1, 1.1))
# patchwork

# (Make sure p_dis_1a, p_dis_2, p_dis_3 and cowplot are loaded)

# 1. Use cowplot to align the top-row plots (same as before)
aligned_plots <- cowplot::align_plots(
  p_dis_1a, 
  p_dis_2,
  align = 'v', # Align vertically
  axis = 'l'   # Match the left axes
)

# 2. Rebuild the top row using wrap_plots() to handle the grobs
#    and then add the layout settings.
top_row <- wrap_plots(aligned_plots, ncol = 2) + 
  plot_layout(widths = c(1, 1.5))

# 3. Combine the aligned top row with the bottom plot
patchwork <- top_row / p_dis_3 + 
  plot_layout(heights = c(1.2, 1))

# Display the final combined plot
patchwork



mms_export_vector(
  plot = patchwork,
  filepath = here("Output", "charts", "I_discrimination.svg"),
  bg_col = pw_bg_color
  )
```


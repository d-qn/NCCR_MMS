---
title: "Work contrat on arrival"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

```{r setup & load data, include=FALSE}
source("_helpers.R")
run_n_check <- T
```

Concernant la variable a6 (année d'arrivée), la codification de celle-ci dépend de l'année de l'enquête dans le sens où dans la première enquête nous sommes parti du plus récent (1 = 2016) au plus ancien (11 = 2006). Tous les deux ans, on a dû adapter les modalités et l'institut de sondage a choisi de continuer de la même manière (du plus récent au plus ancien) mais en commençant successivement en 2018, 2020, 2022.

Voici les formats que j'utilise pour les analyses

value arr22a 1-3 = "2020-2022" 4-8 ="2015-2019" 9-13 ="2010-2014" 14-17 ="2006-2009"; value arr20a 1 = "2020-2022" 2-6 ="2015-2019" 7-11 ="2010-2014" 12-15 ="2006-2009"; value arr18a 1-4 ="2015-2018" 5-9 ="2010-2014" 10-13 ="2006-2009"; value arr16a 1-2 ="2015-2016" 3-7 ="2010-2014" 8-11 ="2006-2009";

```{r wrangle}
data_all <- mms_df %>% 
  mutate(
    contrat = mms_encode_yes_no_code(E4),
    migy = mms_encode_migration_year(A6,year)
  ) %>% 
  # join sexe A1 & country B1
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
  ) %>% 
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes B1.csv"))
  ) %>% 
  left_join(
    migy2yearIntervals
  ) %>% 
  select(contrat, year:mig_4y, everything())


b_df <- data_all %>% 
  mutate(
    sexe = ifelse(sexe == "male", "Hommes", "Femmes")
  ) %>% 
  select(contrat, year:mig_4y)
```



```{r wrangle more & check}

mig2y_df <- b_df %>% 
  group_by(mig_2y, contrat) %>% 
  summarise(
    n = n(),
    weight = sum(weight, na.rm = T)
  ) %>% 
  ungroup() %>% 
  group_by(mig_2y) %>% 
  mutate(
    share = weight/sum(weight),
    n_y = sum(n, na.rm = T)
  ) %>% 
  arrange(desc(share)) %>% 
  mutate(
    share = round(share*100,1)
  ) %>% 
  select(-weight) %>% 
  ungroup() %>% 
  filter(!is.na(mig_2y) & !is.na(contrat))  %>% 
  arrange(mig_2y, contrat)


mig4y_df <- b_df %>% 
  group_by(mig_4y, contrat) %>% 
  summarise(
    n = n(),
    weight = sum(weight, na.rm = T)
  ) %>% 
  ungroup() %>%
  group_by(mig_4y) %>%
  mutate(
    share = weight/sum(weight),
    n_y = sum(n, na.rm = T)
  ) %>%
  arrange(desc(share)) %>%
  mutate(
    share = round(share*100,1)
  ) %>%
  select(-weight) %>%
  ungroup() %>%
  filter(!is.na(mig_4y) & !is.na(contrat)) %>%
  arrange(mig_4y, contrat)
  

fhf_df<- b_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(contrat)) %>%  
  group_by(sexe, contrat) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = T)
  ) %>%
  group_by(sexe) %>%
  mutate(
    share = weight/sum(weight),
    n_sexe = sum(n, na.rm = T)
  ) %>% 
  mutate(
    share = round(share*100,1)
  ) %>% 
  ungroup() %>% 
  mutate(
    contrat = factor(contrat, levels = c("Oui", "Non"))
  ) %>% 
  arrange(contrat, sexe)
  

fpp_df <- b_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(contrat) & (!is.na(pays))) %>%
  group_by(pays, contrat) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = T)
  ) %>%
  group_by(pays) %>%
  mutate(
    share = weight/sum(weight),
    n_pays = sum(n, na.rm = T)
  ) %>%
    mutate(
    share = round(share*100,1)
  ) %>% 
  ungroup() %>%
  mutate(
    contrat = factor(contrat, levels = c("Oui", "Non"))
  ) %>%
  arrange(contrat, pays) %>% 
  filter(n_pays >30)
  
if(run_n_check) {
  fpp_df %>% 
    select(pays, n_pays, share, contrat) %>% 
    pivot_wider(
      names_from = contrat,
      values_from = share
    ) %>%
    arrange(desc(Oui)) %>% 
    kable() 
  
  ## Autre Europe doesn't match !! !!!!!! only
}
  
```

### Viz

```{r main chart}  
mig_job_1 <- mig4y_df %>% 
  filter(contrat == "Oui") %>%
  ggplot(aes(x = mig_4y, y = share, group = 1)) +
  geom_line(aes(linewidth  = n_y), 
            color = nccr_bi_colors[9],
            alpha = 0.2, lineend = "round" )  +
  geom_point(
    aes(size = n_y), alpha = 1,
    color = nccr_bi_colors[10]
  ) +
  theme_mms(grid="Y",
            axis = T,
            mms_txtbox_plot.title(nrow_txt = 2),
            mms_txtbox_plot.subtitle(nrow_txt = 2),
            plot_margin = margin(15, 20, 50, 10)

  ) + 
  theme(
    legend.position = c(0.85, 0.9),
    legend.key.height = unit(0.7, "lines"),
    #legend.spacing.y = unit(0.01, "lines"),
    legend.text = element_text(size = 8, 
                               color = mms_legend_base_col), # Reduce legend text size
    legend.title = element_text(size = 10, 
                                color = mms_legend_base_col, face = "bold", 
                                hjust =0.5) # Reduce legend title size
    ) +
  guides(
    size = guide_legend(
      override.aes = list(
        color = mms_legend_base_col,  # This makes the legend points grey
        fill = mms_legend_base_col    # Just in case the theme uses fill
      )
    )
  )+
  scale_y_continuous(expand = c(0.047,0.012), name = "", 
                     labels = function(x) paste0(x, "%")) +
  labs(
    x = "", y = "",
    subtitle = "Contrat ou offre d’emploi en Suisse au moment du déménagement",
    title = "Près d’une personne sur deux arrive en Suisse avec un contrat de travail",
    size = "n",
    linewidth = "n"
  )

mig_job_1
```



```{r focus by gender in 2024}

mig_job_2 <- fhf_df %>% 
  filter(contrat == "Oui") %>% 
  ggplot(aes(x = sexe, y = share, group = rev(sexe))) +
  geom_col(aes(fill = sexe)) +
  geom_richtext(aes(label = sexe),
                fill = NA, label.color = NA,# remove background and outline,
                size = 4, alpha = 1,
                #fontface = "bold",
                family = mms_base_family,
                vjust = 1.5, color = "white") +
  geom_text(aes(label = paste0(share, "%"), color = sexe), vjust = -.7, 
            family = mms_base_family, size = 3) +
  theme_mms(grid=F,
            axis = F,
            mms_plot_title = mms_txtbox_plot.title(nrow_txt = 3),
            mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  ) + 
  coord_cartesian(clip = "off") +
  theme(
    legend.position = "none",
    plot.background = element_rect(fill = mms_plot_bg_color, linewidth = 0),
    #plot.title.position = "plot",
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    
    #axis.text.x = element_text(color = rc_axis_tick_txt_color),
  ) +
  scale_x_discrete(expand = c(0.4,0.1))+
    scale_y_continuous(expand = c(0,1), name = "", 
                     labels = function(x) paste0(x, "%")) +
  scale_fill_manual(values = nccr_bi_colors[c(2,4)]) +
  scale_color_manual(values = nccr_bi_colors[c(2,4)]) +
   labs(
    x = "", y = "",
    subtitle = "Contrat ou offre d’emploi en Suisse au moment du déménagement, par sexe en 2024",
    title = str_c("Le contrat de travail, deux fois plus fréquent chez les <span style='color:", 
    nccr_bi_colors[4], ";'>hommes</span> que chez les <span style='color:",
                  nccr_bi_colors[2], 
                  ";'>femmes</span>")# à l’arrivée en Suisse")
  )

mig_job_2
```


```{r focus par pays}

fpp_pays_ordered <- fpp_df %>% 
  filter(contrat == "Oui") %>% 
  mutate(
    pays = factor(pays) %>% fct_reorder(share, .desc = T)
  ) %>% 
  arrange(pays) %>% 
  .$pays %>% as.character()

fpp2mekko_df <- mms_mekko_wrangler(
  fpp_df %>% 
    mutate(
      pays = factor(pays, levels = fpp_pays_ordered),
      contrat = factor(contrat),
    ) %>% arrange(pays),
  var1 = "contrat", 
  var2 = "pays", 
  varv = "share", 
  tot_n = "n_pays"
) %>% 
  left_join(pays2col)
  
col_couple <- nccr_bi_colors[10] #, amount = 0.2) %>% desaturate(0.1) #colorspace::adjust_transparency("#3f2d54", alpha = 0.4)
col_seul <- desaturate(nccr_bi_colors[9], amount = 0.4) %>% lighten(amount = 0.4) #"#c9d175" 
fpp_col <- c(col_couple, col_seul)

fpp_chart <- fpp2mekko_df %>%   
  ggplot() +
  geom_rect(aes(xmin = xmin, xmax = xmax, 
                ymin = ymin, ymax = ymax,
                fill = contrat),
            colour = "white", #nccr_bi_colors[13]
             size = 0.9, alpha = 1) +
  theme_mms(
    grid="X", axis=F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 4),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  ) + 
  theme(
    legend.position = "none",
    axis.line.x = element_blank()
  ) + 
  scale_fill_identity() +
  scale_fill_manual(values = fpp_col) +
  geom_vline(xintercept = 50, linetype = "dashed",
             linewidth = 0.5, color = nccr_bi_colors[13]) +
  scale_x_continuous(name = "", expand = c(0,0), position = "top",
                     labels = function(x) paste0(x, "%"),
                     breaks = c(50)) +
  scale_y_continuous(name = "",  labels = NULL, expand = c(0,0))

#fpp_chart

# job labels tibble
fpp_pays_labels <- fpp2mekko_df %>%
  filter(contrat == "Oui") %>%
  mutate(y = ymax - 0.01, yRange = (ymax - ymin)* 100) %>%
  select(pays, xmin, y, yRange) %>%
  ungroup() %>% 
  mutate(
    # Insert line breaks between words
    labels = gsub(" ", "<br>", pays)
  )

fpp_value_labels <- fpp2mekko_df %>% 
  select(pays, contrat, xmin, xmax, ymin, ymax, share) %>%
  mutate(
    x = ifelse(contrat == "Oui", xmax, xmin),
    y = ymax - 0.01,
    label = paste0(round(share, 1), "%"),
    hjust = ifelse(contrat == "Oui", 1.05, -0.05)
  ) 

mig_job_3 <- fpp_chart +
   geom_richtext(
    data = fpp_pays_labels,
    aes(x = xmin + 0.01, y = y, 
        label = labels),
    fill = NA, label.color = NA,# remove background and outline,
    size = 3.5,
    hjust = 0, nudge_x = .5, vjust = 1, colour = "white",
    family = mms_base_family
  ) +
  geom_richtext(
    data = fpp_value_labels,
    aes(x = x + 0.01, y = ymin, label = label, hjust = hjust),
    fill = NA, label.color = NA,# remove background and outline,
    vjust = 0, nudge_y = 0.005, size = 3, alpha = 0.9, colour = "white",
    family = mms_base_family
  ) +
  annotate(
    geom = "richtext",
    x=90,y = 0.5, angle = -90, label = "sans emploi",
    fill = NA, label.color = NA,# remove background and outline,
    size = 10,
    family = mms_base_family, fontface = "bold", 
    alpha = 0.6,
    color = nccr_bi_colors[9] #"white"
  ) +
  labs(
    title = str_c("Les ressortissants de pays voisins s’installent plus souvent en Suisse avec un emploi"),
    subtitle = str_c("Contrat ou offre d’emploi en Suisse au moment du déménagement, par pays d'origine en 2024"),
    caption = str_c("La hauteur des barres est proportionnelle à la taille de l’échantillon (n), total des sondés: ",#,
                    fpp2mekko_df$n %>% sum()%>% prettyNum(big.mark = " ") 
   )
  )
mig_job_3
```

```{r patch}


patchwork <- (mig_job_1 /mig_job_2) +
   plot_layout(heights = c(1, 1)) | mig_job_3 
patchwork

#patchwork <- (edu_chart_1a + edu_chart2_a) / edu_chart3
# patchwork
# 
# (edu_chart1_a + edu_chart2_a) / edu_chart3

svglite::svglite(
  filename = here("Output", "charts", "B_travail.svg"),
  height = 11.7,
  width = 8.3,
  fix_text_size = T,
  bg = pw_bg_color
  )

patchwork + 
  plot_annotation(
    title="Un contrat de travail au moment de l’arrivée en Suisse",
    theme = theme(
      plot.title.position = 'plot', 
      plot.title = element_textbox_simple(
        size = 20, 
        hjust = 0,
        colour = "#0c0b0e",
        face = "bold",
        family = mms_base_family,
        lineheight = 1.3,
        padding = pw_padding,
        margin =  pw_margin
      )))
  

dev.off()



```
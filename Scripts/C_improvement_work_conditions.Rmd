---
title: "La migration conduit généralement à une amélioration des conditions de travail"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

Variable
E27 : Concernant votre statut professionnel, que diriez-vous de manière générale si vous comparez votre situation d’aujourd’hui avec celle que vous aviez avant votre déménagement en Suisse en {#fa6} ? Elle …
Evolution par année
Résultat
Une majorité de personnes interrogées actives indique que la situation professionnelle s’est améliorée avec la migration, comparativement à la situation professionnelle précédant la migration. Peu d’évolution en fonction de l’année de l’enquête

E27	Regarding your professional situation, what would you say overall when comparing your situation today with your situation before moving to Switzerland in [A6]? It has…
	1.        improved substantially
	2.        improved slightly
	3.        remained the same
	4.        worsened slightly
	5.        worsened substantially
	-9. No answer

```{r setup & load data, include=FALSE}
source("_helpers.R")
run_n_check <- T
```


```{r wrangle}
wcond_codes <- tibble(
  E27 = c(1, 2, 3, 4, 5),
  wcond5 = c("Considérablement améliorée ", "Légèrement améliorée", 
            "Identique", "Légèrement détériorée", 
            "Considérablement détériorée"),
  wcond3 = c("Amélioration", "Amélioration", "Identique", 
             "Détérioration", "Détérioration")
)


data_all <- mms_df %>% 
  left_join(
    wcond_codes, by = "E27"
  ) %>% 
  mutate(
    wcond5 = factor(wcond5, levels=rev(wcond_codes$wcond5)),
    wcond3 = factor(wcond3, levels = rev(c("Amélioration", "Identique", "Détérioration"))),
    # A2 year of birth
    age = year - A2,
    age_gr2 = ifelse(
      age < 40, "Moins de 40 ans", "40+ ans"),
    migy = mms_encode_migration_year(A6,year)
  ) %>% 
  # join sexe A1 & country B1
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
  ) %>% 
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes B1.csv"))
  ) %>% 
  left_join(
    migy2yearIntervals
  ) %>% 
  select(year:mig_4y, everything())


c_df <- data_all %>% 
  select(year:mig_4y)
  
```


```{r wrangle more & check}
wcond3_df <- c_df %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(year, wcond3) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup()

wcond5_df <- c_df %>% 
  filter(!is.na(wcond5)) %>% 
  group_by(year, wcond5) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup()

if(run_n_check) {
  wcond3_df %>% 
    select(year, n_y, wcond3, share) %>%
    pivot_wider(
      names_from = wcond3,
      values_from = share
    ) 
}


wcond_p_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(pays, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(pays) %>%
  mutate(
    n_pays = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight) 

wcond5_p_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond5)) %>% 
  group_by(pays, wcond5) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(pays) %>%
  mutate(
    n_pays = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight) %>% 
  group_by(pays) %>% 
  mutate (
    am_tot = sum(share[grepl("améliorée", wcond5)], na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  mutate(
    pays = fct_reorder(pays, am_tot, .fun = mean)
  )



if(run_n_check) {
  wcond_p_df %>% 
    select(pays, wcond3, n_pays, share) %>% 
    pivot_wider(
      names_from = wcond3,
      values_from = share
    )  
}
wcond_sexe_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(sexe, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(sexe) %>%
  mutate(
    n_sexe = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)

if(run_n_check) {
  wcond_sexe_df %>% 
    select(sexe, wcond3, n_sexe, share) %>% 
    pivot_wider(
      names_from = wcond3,
      values_from = share
    )  
}


wcond_age_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(age_gr2, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(age_gr2) %>%
  mutate(
    n_age = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)

```

### VIZ

```{r main chart}
wcond_area <- wcond5_df %>% 
 # arrange(wcond5) %>%
  ggplot(aes(x = year, y = share, group = wcond5)) +
  geom_area(aes(fill = wcond5), alpha = 0.96) + 
  theme_mms(
    grid="XY", axis=F
  ) + 
  theme(
    legend.position = "none",
    panel.background = element_rect(fill = NA),  # transparent
    panel.ontop = TRUE
  ) +
  # remove any scale expansion
  scale_x_continuous(expand = c(0,0), name = "", breaks = seq(2016, 2024, 2)) +
  # have y scale not start at 0, add unit % 
  scale_y_continuous(expand = c(0,0), name = "", 
                     labels = function(x) paste0(x, "%"),
                     breaks = c(25,50,75))+
  scale_fill_manual(values = nccr_divergent_orange_green()[c(1,3,5,7,9)]) +
  labs(
    title = str_c(
      "Une majorité de personnes connaissent une ",
      " <span style='color:",
                  nccr_bi_colors[12], 
                  ";'>amélioration</span> ",
      " de leur situation professionnelle avec la migration"),
    subtitle="Avec la migration, la situation professionnelle s'est:")

#wcond_area
annot_df <- tibble(
  year = c(2016, 2016, 2020, 2024,2024),
  share_w = rev(c(27, 65, 86, 93, 98.5)),
  txt = wcond5_df$wcond5 %>% levels(),
  hjust = c(0, 0, 0.5, 1, 1)
) %>% 
  left_join(
    wcond5_df %>% group_by(wcond5) %>% 
      summarise(size_share = mean(share, na.rm = TRUE)),
    by = c("txt" = "wcond5" )
  )

wcond_chart_1 <- wcond_area +
  geom_richtext(data = annot_df, 
                aes(x = year, y = share_w, label = txt, group = 1,  
                    size = size_share, hjust = hjust),
                nudge_x = c(0.1, 0.1, 0, -0.1, -0.1),
                fill = NA, label.color = NA,# remove background and outline,
                color = "white", 
                fontface = "bold",
                family = mms_base_family
  ) +
  scale_size_continuous(range = c(3, 6), guide = "none") 
wcond_chart_1

```

# https://stackoverflow.com/questions/49161918/plot-divergent-stacked-bar-chart-with-ggplot2
# https://rfortherestofus.com/2021/10/diverging-bar-chart

```{r divergent stacked bars}

wcond5_labels_df <- wcond5_p_df %>%
  mutate(wcond5 = trimws(wcond5)) %>%  # enlever espaces inutiles
  group_by(pays) %>%
  summarise(
    total_amelioration = sum(share[wcond5 %in% c("Légèrement améliorée", "Considérablement améliorée")]),
    total_deterioration = sum(share[wcond5 %in% c("Légèrement détériorée", "Considérablement détériorée")])
  ) %>%
  mutate(
    total_amelioration_lbl = paste0("<span style='color:#457651;'>", round(total_amelioration, 1), "%</span>"),
    total_deterioration_lbl = paste0("<span style='color:#985d45;'>", round(total_deterioration, 1), "%</span>"),
    pays = factor(pays, levels = rev(sort(unique(wcond5_p_df$pays))))  # ordre pour coord_flip()
  )

fpp2mekko_labels_df <- fpp2mekko_df %>%
  filter(contrat == "Oui") %>%
  mutate(y = ymax - 0.01, yRange = (ymax - ymin)* 100) %>%
  select(pays, xmin, y, yRange) %>%
  ungroup() %>% 
  mutate(
    # Insert line breaks between words
    labels = gsub(" ", "<br>", pays)
  )

wcond5_p_df %>% 
  arrange(desc(pays)) %>% 
  ggplot(aes(x = pays, y = share)) +
  geom_bar(aes( fill = wcond5), stat = "identity", position = "fill") +
  coord_flip(clip = "off") +
  scale_fill_manual(values = nccr_divergent_orange_green()[c(1,3,5,7,9)]) +
  theme_mms(
    grid="X", axis=F
  ) + 
  theme(
  #  legend.position = "none"
  ) +
 scale_y_continuous(
    name = "", expand = c(0.15, 0),
    labels = function(x) paste0(x * 100, "%"),  # share est entre 0 et 1 ici
    breaks = c(0.25, 0.5, 0.75),
    position = "right"
  ) +
  scale_x_discrete(expand = c(0.07, 0), name = "") +
  labs(
    title = "En 2024, la majorité des personnes migrantes en Suisse",
    subtitle = "Situation actuelle sur le marché du travail, comparativement à avant la migration, en 2024, par pays d'origine"
  ) +
  geom_richtext(
    data = wcond5_labels_df,
    aes(x = pays, y = -0.02, label = total_amelioration_lbl),
    hjust = 1,  label.color = NA, size = 5
  ) +
  geom_richtext(
    data = wcond5_labels_df,
    aes(x = pays, y = 1.02, label = total_deterioration_lbl),
    hjust = 0, fill = NA, label.color = NA, size = 5
  ) +
  #   geom_richtext(
  #   data = fpp2mekko_labels_df,
  #   aes(x = xmin + 0.01, y = y, 
  #       label = labels),
  #   fill = NA, label.color = NA,# remove background and outline,
  #   size = 3.5,
  #   hjust = 0, nudge_x = .5, vjust = 1, colour = "white",
  #   family = mms_base_family
  # ) +
  annotate("text", x = nlevels(wcond5_p_df$pays), y = -.07, 
           label = "Amélioration", vjust = -5, hjust = 0.5, size = 5, 
           family = mms_base_family, fontface = "bold") +
  annotate("text", x = nlevels(wcond5_p_df$pays), y = 1.07, 
           label = "Détérioration", vjust = -5, hjust = 0.5, size = 5, 
           family = mms_base_family, fontface = "bold") 
  
```

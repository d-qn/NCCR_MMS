---
title: "La migration conduit généralement à une amélioration des conditions de travail"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

Variable
E27 : Concernant votre statut professionnel, que diriez-vous de manière générale si vous comparez votre situation d’aujourd’hui avec celle que vous aviez avant votre déménagement en Suisse en {#fa6} ? Elle …
Evolution par année
Résultat
Une majorité de personnes interrogées actives indique que la situation professionnelle s’est améliorée avec la migration, comparativement à la situation professionnelle précédant la migration. Peu d’évolution en fonction de l’année de l’enquête

E27	Regarding your professional situation, what would you say overall when comparing your situation today with your situation before moving to Switzerland in [A6]? It has…
	1.        improved substantially
	2.        improved slightly
	3.        remained the same
	4.        worsened slightly
	5.        worsened substantially
	-9. No answer

```{r setup & load data, include=FALSE}
source("_helpers.R")
run_n_check <- T
```


```{r wrangle}
wcond_codes <- tibble(
 E27 = c(1, 2, 3, 4, 5),
 wcond5 = c("Significantly improved", "Slightly improved", 
           "Unchanged", "Slightly deteriorated", 
           "Significantly deteriorated"),
 wcond3 = c("Improved", "Improved", "Unchanged", 
            "Deteriorated", "Deteriorated")
)


data_all <- mms_df %>% 
  left_join(
    wcond_codes, by = "E27"
  ) %>% 
  mutate(
    wcond5 = factor(wcond5, levels=rev(wcond_codes$wcond5)),
    wcond3 = factor(wcond3, levels = rev(c("Improved", "Unchanged", "Deteriorated"))),
    # A2 year of birth
    age = year - A2,
    age_gr2 = ifelse(
      age < 40, "Less than 40 years", "40+ years"),
    migy = mms_encode_migration_year(A6,year)
  ) %>% 
  # join sexe A1 & country B1
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
  ) %>% 
  left_join(
    read_csv(here("Data", "code2txt", "NCCR_MMS_codes - B1.csv"))
  ) %>% 
  left_join(
    migy2yearIntervals
  ) %>% 
  select(year:mig_4y, everything())


c_df <- data_all %>% 
  select(year:mig_4y)
  
```


```{r wrangle more & check}
wcond3_df <- c_df %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(year, wcond3) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup()

wcond5_df <- c_df %>% 
  filter(!is.na(wcond5)) %>% 
  group_by(year, wcond5) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup()

if(run_n_check) {
  wcond3_df %>% 
    select(year, n_y, wcond3, share) %>%
    pivot_wider(
      names_from = wcond3,
      values_from = share
    ) 
}


wcond_p_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(country, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(country) %>%
  mutate(
    n_pays = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight) 

wcond5_p_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond5)) %>% 
  group_by(country, wcond5) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(country) %>%
  mutate(
    n_pays = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight) %>% 
  group_by(country) %>% 
  mutate (
    am_tot = sum(share[which(wcond5 %in% wcond_codes$wcond5[c(1,2)])], na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  mutate(
    country = fct_reorder(country, am_tot)
  )

wcond3_p_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(country, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(country) %>%
  mutate(
    n_pays = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight) %>% 
  group_by(country) %>% 
  mutate (
    am_tot = sum(share[which(wcond3 %in% wcond_codes$wcond3[1])], na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  mutate(
    country = fct_reorder(country, am_tot)
  )



if(run_n_check) {
  wcond_p_df %>% 
    select(country, wcond3, n_pays, share) %>% 
    pivot_wider(
      names_from = wcond3,
      values_from = share
    )  
}
wcond_sexe_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(sexe, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(sexe) %>%
  mutate(
    n_sexe = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)

if(run_n_check) {
  wcond_sexe_df %>% 
    select(sexe, wcond3, n_sexe, share) %>% 
    pivot_wider(
      names_from = wcond3,
      values_from = share
    )  
}


wcond_age_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(age_gr2, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(age_gr2) %>%
  mutate(
    n_age = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)

wcond_mig4y_df <- c_df %>% 
  filter(!is.na(wcond3)) %>% 
  filter(!is.na(mig_4y)) %>% 
  group_by(mig_4y, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(mig_4y) %>%
  mutate(
    n_mig_4y = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)


```

### VIZ

```{r main chart}
iwc_1 <- wcond5_df %>% 
 # arrange(wcond5) %>%
  ggplot(aes(x = year, y = share, group = wcond5)) +
  geom_area(aes(fill = wcond5), alpha = 1) + 
  theme_mms(
    grid=F, axis=F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 3),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 0)
  ) + 
  theme(
    legend.position = "none",
    panel.background = element_rect(fill = NA),  # transparent
    panel.ontop = TRUE
  ) +
  # remove any scale expansion
  scale_x_continuous(expand = c(0,0), name = "", breaks = seq(2016, 2024, 2)) +
  # have y scale not start at 0, add unit % 
  scale_y_continuous(expand = c(0,0), name = "", 
                     labels = function(x) paste0(x, "%"),
                     breaks = c(25,50,75))+
  scale_fill_manual(values = nccr_divergent_orange_green()[c(1,3,5,7,9)]) +
  labs(
    title = 
      str_c(
        "A majority of people experience an ",
        "<span style='color:",
        nccr_bi_colors[12], 
        ";'>improvement</span> ",
        "in their professional situation with migration"
      ),
    subtitle="With migration, the professional situation was:")

#wcond_area
annot_df <- tibble(
  year = c(2016, 2016, 2020, 2024,2024),
  share_w = rev(c(27, 65, 86, 93, 98.5)),
  txt = wcond5_df$wcond5 %>% levels(),
  hjust = c(0, 0, 0.5, 1, 1)
) %>% 
  left_join(
    wcond5_df %>% group_by(wcond5) %>% 
      summarise(size_share = mean(share, na.rm = TRUE)),
    by = c("txt" = "wcond5" )
  )

iwc_1a <- iwc_1 +
  geom_richtext(data = annot_df, 
                aes(x = year, y = share_w, label = txt, group = 1,  
                    size = size_share, hjust = hjust),
                nudge_x = c(0.1, 0.1, 0, -0.1, -0.1),
                fill = NA, label.color = NA,# remove background and outline,
                color = "white", 
                #fontface = "bold",
                family = mms_base_family
  ) +
  scale_size_continuous(range = c(2, 6), guide = "none") 
iwc_1a

```

# https://stackoverflow.com/questions/49161918/plot-divergent-stacked-bar-chart-with-ggplot2
# https://rfortherestofus.com/2021/10/diverging-bar-chart

```{r 2 divergent stacked bars}

wcond5_labels_df <- wcond5_p_df %>%
  mutate(wcond5 = trimws(wcond5)) %>%  # enlever espaces inutiles
  group_by(country) %>%
  summarise(
    total_amelioration = sum(share[wcond5 %in% wcond_codes$wcond5[c(1,2)]]),
    total_deterioration = sum(share[wcond5 %in% wcond_codes$wcond5[c(4,5)]])
  ) %>%
  mutate(
    total_amelioration_lbl = paste0("<span style='color:#457651;'>", round(total_amelioration, 1), "%</span>"),
    total_deterioration_lbl = paste0("<span style='color:#985d45;'>", round(total_deterioration, 1), "%</span>"),
    country = factor(country, levels = rev(sort(unique(wcond5_p_df$country))))  # ordre pour coord_flip()
  ) %>% 
  mutate(
    y = 0.005,
    # Insert line breaks between words
    labels = gsub(" ", "<br>", as.character(country))
  )

wcond3_labels_df <- wcond3_p_df %>%
  mutate(wcond3 = trimws(wcond3)) %>%  # enlever espaces inutiles
  group_by(country) %>%
  summarise(
    total_amelioration = sum(share[wcond3 == "Improved"]),
    total_deterioration = sum(share[wcond3 == "Deteriorated"])
  ) %>%
  mutate(
    total_amelioration_lbl = paste0("<span style='color:#f2f2f2;'>", round(total_amelioration, 1), "%</span>"),
    total_deterioration_lbl = paste0("<span style='color:#985d45;'>", round(total_deterioration, 1), "%</span>"),
    country = factor(country, levels = rev(sort(unique(wcond3_p_df$country))))  # ordre pour coord_flip()
  ) %>% 
  mutate(
    y = 0.005,
    # Insert line breaks between words
    labels = gsub(" ", "<br>", as.character(country))
  )

iwc_2 <- wcond3_p_df %>% 
  arrange(desc(country)) %>%
  ggplot(aes(x = country, y = share)) +
  geom_bar(aes( fill = wcond3), stat = "identity", position = "fill") +
  coord_flip(clip = "off") +
  scale_fill_manual(values = nccr_divergent_orange_green()[c(1,5,9)]) +
  theme_mms(
    grid="X", axis=F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 3),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  ) + 
  theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.x = element_text(size = 13, hjust = 0.35)
  ) +
 scale_y_continuous(
    name = "", expand = c(0, 0),
    labels = function(x) paste0(x * 100, "%"),  # share est entre 0 et 1 ici
    breaks = c(0.5),
    position = "right"
  ) +
  scale_x_discrete(expand = c(0, 0), name = "") +
  labs(
    title = "Improvement in professional situation varies by country of origin",
    subtitle = "In 2024, with migration, the professional situation was: "
  ) +
  geom_hline(
    yintercept = 0.5, 
    linetype = "dashed", 
    color = "white", 
    linewidth = 0.3
  ) +
  geom_richtext(
    data = wcond3_labels_df,
    aes(x = country, y = total_amelioration/100,
        label = total_amelioration_lbl),
    fill = NA,
    family = mms_base_family,
    hjust = 1, label.color = NA, size = 3
  ) +
  geom_richtext(
    data = wcond3_labels_df,
    aes(x = country, y = 1.001, label = total_deterioration_lbl),
    family = mms_base_family,
    hjust = 0, fill = NA, label.color = NA, size = 3
  ) +
  geom_richtext(
    data = wcond3_labels_df,
    aes(x = country, y = y,
        label = labels),
    fill = NA, label.color = NA,# remove background and outline,
    size = 3.5,
    hjust = 0, nudge_x = 0, vjust = 0.5, colour = "white",
    family = mms_base_family#, fontface = "bold"
  ) +
  annotate("text", x = nlevels(wcond3_p_df$country), y = 0,
           label = "Improved", vjust = -3, hjust = 0, 
           size = 3,
           family = mms_base_family, fontface = "bold",
           color = nccr_divergent_orange_green()[9]) +
  annotate("text", x = nlevels(wcond3_p_df$country), y = 1,
           label = "Deteriorated", vjust = -3, hjust = 1, 
           size = 3,
           family = mms_base_family, fontface = "bold",
           color = nccr_divergent_orange_green()[1])
iwc_2


# iwc_2 <- wcond5_p_df %>% 
#   arrange(desc(country)) %>% 
#   ggplot(aes(x = country, y = share)) +
#   geom_bar(aes( fill = wcond5), stat = "identity", position = "fill") +
#   coord_flip(clip = "off") +
#   scale_fill_manual(values = nccr_divergent_orange_green()[c(1,3,5,7,9)]) +
#   theme_mms(
#     grid="X", axis=F
#   ) + 
#   theme(
#     legend.position = "none",
#     axis.text.y = element_blank(),
#     panel.grid.major = element_blank(),
#     axis.text.x = element_text(size = 13, hjust = 0.35)
#   ) +
#  scale_y_continuous(
#     name = "", expand = c(0.1, 0),
#     labels = function(x) paste0(x * 100, "%"),  # share est entre 0 et 1 ici
#     breaks = c(0.5),
#     position = "right"
#   ) +
#   scale_x_discrete(expand = c(0, 0), name = "") +
#   labs(
#     title = "Improvement in professional situation varies by country of origin",
#     subtitle = "In 2024, with migration, the professional situation is: "
#   ) +
#   geom_hline(
#     yintercept = 0.5, 
#     linetype = "dashed", 
#     color = "white", 
#     linewidth = 0.3
#   ) +
#   geom_richtext(
#     data = wcond5_labels_df,
#     aes(x = country, y = -0.02, label = total_amelioration_lbl),
#     hjust = 1,  label.color = NA, size = 4#,
#   #  fontface = "bold"
#   ) +
#   geom_richtext(
#     data = wcond5_labels_df,
#     aes(x = country, y = 1.02, label = total_deterioration_lbl),
#     hjust = 0, fill = NA, label.color = NA, size = 4
#   ) +
#   geom_richtext(
#     data = wcond5_labels_df,
#     aes(x = country, y = y,
#         label = labels),
#     fill = NA, label.color = NA,# remove background and outline,
#     size = 4,
#     hjust = 0, nudge_x = 0, vjust = 0.5, colour = "white",
#     family = mms_base_family#, fontface = "bold"
#   ) +
#   annotate("text", x = nlevels(wcond5_p_df$country), y = -.05, 
#            label = "Improved", vjust = -5, hjust = 0.5, size = 4, 
#            family = mms_base_family, fontface = "bold", 
#            color = nccr_divergent_orange_green()[9]) +
#   annotate("text", x = nlevels(wcond5_p_df$country), y = 1.01, 
#            label = "Deteriorated", vjust = -5, hjust = 0.5, size = 4, 
#            family = mms_base_family, fontface = "bold",
#            color = nccr_divergent_orange_green()[1]) 
  
#iwc_2

```


```{r 3 sexe & age}
wcond_sa_df <- bind_rows(
  wcond_sexe_df %>% 
    rename(var = sexe, n_var = n_sexe) %>% 
    mutate(varname = "By gender"),
  
  wcond_age_df %>% 
    rename(var = age_gr2, n_var = n_age) %>% 
    mutate(varname = "By age")  
) %>% 
  mutate(
    varname = fct_relevel(varname, "By gender", "By age")
  )


wcond_sa_labels <- wcond_sa_df %>% 
  group_by(var, varname) %>% 
  summarise(
    total_amelioration = share[wcond3 == "Improved"],
    total_deterioration = share[wcond3 == "Deteriorated"]
  ) %>% 
  mutate(
    total_amelioration_lbl = paste0("<span style='color:#f2f2f2;'>", round(total_amelioration, 1), "%</span>"),
    total_deterioration_lbl = paste0("<span style='color:#985d45;'>", round(total_deterioration, 1), "%</span>"),
    var = fct_reorder(var, total_amelioration, .fun = mean)
  ) %>% 
  mutate(
    y = 0.005,
    # Insert line breaks between words
    labels =  case_when(
      var == "male" ~ "Men",
      var == "female" ~ "Women",
      T ~ var) %>% as.character() #gsub(" ", "<br>", as.character(var))
  )

iwc_3 <- wcond_sa_df %>% 
  # drop empty levels 
  ggplot(aes(x = factor(var), y = share)) +
  facet_wrap(~varname, ncol = 1, scales = "free_y") +
  geom_bar(aes(fill = wcond3), stat = "identity", position = "fill") +
  #   geom_hline(
  #   yintercept = 0.5, 
  #   linetype = "dashed", 
  #   color = "white", 
  #   linewidth = 0.3
  # ) +
  geom_richtext(data = wcond_sa_labels, 
                aes(x = var, y = total_amelioration / 100, 
                    label = total_amelioration_lbl),
                fill = NA, family = mms_base_family,
                hjust = 1,  label.color = NA, size = 3#,
    #  fontface = "bold"
  ) +
  geom_richtext(data = wcond_sa_labels, 
                aes(x = var, y = 1, 
                    label = total_deterioration_lbl),
                hjust = 0, fill = NA, label.color = NA, size = 3,
                family = mms_base_family) +
  geom_richtext(data = wcond_sa_labels,
                aes(x = var, y = y,
                    label = labels),
                fill = NA, label.color = NA,# remove background and outline,
                size = 4,
                hjust = 0, nudge_x = 0, vjust = 0.5, colour = "white",
                family = mms_base_family#, fontface = "bold"
  ) +
  coord_flip(clip = "on") +
  scale_fill_manual(values = nccr_divergent_orange_green()[c(1,5,9)]) +
  theme_mms(
    grid=F, axis=F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 2),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  ) + 
  theme(
    panel.grid.major = element_blank(),
    #axis.text.x = element_text(size = 13, hjust = 0.35),
    #axis.ticks.y = element_blank(),
    legend.position = "none",
    axis.text.y = element_blank(),
    panel.spacing.y = unit(.4, "cm"),  # reduce space between facets
    strip.text = element_text(hjust = 0),# 0 = left, 0.5 = center, 1 = right
    theme(aspect.ratio = 0.7)  # Makes height 50% of width
  ) +
  scale_y_continuous(
    name = "", expand = c(0.07, 0),
    labels = function(x) paste0(x * 100, "%"),  # share est entre 0 et 1 ici
    breaks = NULL,
    position = "right"
  ) +
  scale_x_discrete(expand = c(0, 0), name = "", drop = TRUE) +
  labs(
    title = "Professional improvement varies by gender and age",
    subtitle = "In 2024, with migration, the professional situation is: "
  ) #+ debug_theme

iwc_3

```


```{r migation year group}

wcondi_labels <- wcond_mig4y_df %>% 
  filter(wcond3 == "Improved") %>% 
  select(mig_4y, share, wcond3) 

iwc_4 <- wcond_mig4y_df %>% 
  ggplot(aes(x = mig_4y, y = share, group = wcond3)) +
  geom_col(aes(fill = wcond3), alpha = 0.96) + 
  geom_text(
    data = wcondi_labels,
    aes(label = paste0(share, "%")),
    vjust = 2.2,
    color = "white",
    size = 4,
    family = mms_base_family
  ) +
  theme_mms(
    grid="", axis=F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 3),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  ) + 
  theme(
    legend.position = "none",
    axis.text.y = element_blank()
    #panel.background = element_rect(fill = NA),  # transparent
    #panel.ontop = TRUE
  ) +
  # remove any scale expansion
  scale_x_discrete(expand = c(0,0), name = "") +
  # have y scale not start at 0, add unit % 
  scale_y_continuous(expand = c(0,0), name = "", 
                     labels = function(x) paste0(x, "%")#,
                    # breaks = c(25,50,75)
                    )+
  scale_fill_manual(values = nccr_divergent_orange_green()[c(1,5,9)]) +
   labs(
    title = "Long-established residents report more improvements in their professional situation",
    subtitle = "Labor market outcomes in 2024 vs. pre-migration status, by years since arrival"
  )

```


```{r patch}

patchwork <- ((iwc_1a /iwc_4) +
  plot_layout(heights = c(1.5, 1,1.3)) | iwc_2) +
  plot_layout(widths = c(1,1.2))
patchwork

patchwork <- ((iwc_1a /iwc_4) +
  plot_layout(heights = c(1.3,1)) | (iwc_2/iwc_3) +
    plot_layout(heights = c(3,1),  widths = 1, ncol = 1, guides = "collect")) +
  plot_layout(widths = c(1,1))
patchwork


mms_export_vector(
  plot = patchwork,
  filepath = here("Output", "charts", "C_work_improvement.svg"),
  bg_col = pw_bg_color
  )


```
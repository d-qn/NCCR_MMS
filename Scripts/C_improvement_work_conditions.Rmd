---
title: "La migration conduit généralement à une amélioration des conditions de travail
"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

Variable
E27 : Concernant votre statut professionnel, que diriez-vous de manière générale si vous comparez votre situation d’aujourd’hui avec celle que vous aviez avant votre déménagement en Suisse en {#fa6} ? Elle …
Evolution par année
Résultat
Une majorité de personnes interrogées actives indique que la situation professionnelle s’est améliorée avec la migration, comparativement à la situation professionnelle précédant la migration. Peu d’évolution en fonction de l’année de l’enquête

E27	Regarding your professional situation, what would you say overall when comparing your situation today with your situation before moving to Switzerland in [A6]? It has…
	1.        improved substantially
	2.        improved slightly
	3.        remained the same
	4.        worsened slightly
	5.        worsened substantially
	-9. No answer

```{r setup & load data, include=FALSE}
source("Scripts/_helpers.R")
run_n_check <- T
```


```{r wrangle}
wcond_codes <- tibble(
  E27 = c(1, 2, 3, 4, 5),
  wcond5 = c("Considérablement améliorée ", "Légèrement améliorée", 
            "Identique", "Légèrement détériorée", 
            "Considérablement détériorée"),
  wcond3 = c("Amélioration", "Amélioration", "Identique", 
             "Détérioration", "Détérioration")
)


data_all <- mms_df %>% 
  left_join(
    wcond_codes, by = "E27"
  ) %>% 
  mutate(
    wcond5 = factor(wcond5, levels=rev(wcond_codes$wcond5)),
    wcond3 = factor(wcond3, levels = rev(c("Amélioration", "Identique", "Détérioration"))),
    # A2 year of birth
    age = year - A2,
    age_gr2 = ifelse(
      age < 40, "Moins de 40 ans", "40+ ans"),
    migy = mms_encode_migration_year(A6,year)
  ) %>% 
  # join sexe A1 & country B1
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
  ) %>% 
  left_join(
    read_csv(here("Data", "code2txt", "NCCR MMS Codes B1.csv"))
  ) %>% 
  left_join(
    migy2yearIntervals
  ) %>% 
  select(year:mig_4y, everything())


c_df <- data_all %>% 
  select(year:mig_4y)
  
```


```{r wrangle more & check}
wcond3_df <- c_df %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(year, wcond3) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup()

wcond5_df <- c_df %>% 
  filter(!is.na(wcond5)) %>% 
  group_by(year, wcond5) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup()

if(run_n_check) {
  wcond3_df %>% 
    select(year, n_y, wcond3, share) %>%
    pivot_wider(
      names_from = wcond3,
      values_from = share
    ) 
}


wcond_p_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(pays, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(pays) %>%
  mutate(
    n_pays = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight) 


if(run_n_check) {
  wcond_p_df %>% 
    select(pays, wcond3, n_pays, share) %>% 
    pivot_wider(
      names_from = wcond3,
      values_from = share
    )  
}
wcond_sexe_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(sexe, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(sexe) %>%
  mutate(
    n_sexe = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)

if(run_n_check) {
  wcond_sexe_df %>% 
    select(sexe, wcond3, n_sexe, share) %>% 
    pivot_wider(
      names_from = wcond3,
      values_from = share
    )  
}


wcond_age_df <- c_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(wcond3)) %>% 
  group_by(age_gr2, wcond3) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>% 
  group_by(age_gr2) %>%
  mutate(
    n_age = sum(n, na.rm = TRUE),
    tot_weight = sum(weight, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(-tot_weight)

```

### VIZ

```{r main chart}
wcond_area <- wcond5_df %>% 
  arrange(wcond5) %>%
  ggplot(aes(x = year, y = share, group = wcond5)) +
  geom_area(aes(fill = wcond5), alpha = 0.9) + 
  theme_ipsum_rc(grid="XY", axis="xy", 
                 grid_col = "black",
                 base_size = rc_base_size,
                 plot_title_size = rc_plot_title_size,
                 subtitle_size = rc_subtitle_size,
                 plot_margin = plot_margin
  ) + 
  theme(
    #legend.position = "none",
    plot.background = element_rect(fill = main_plot_bg_color, linewidth = 0), #color = "#3f2d54", linewidth = 0.5),
    #plot.title.position = "plot",
    plot.title = rc_txtbox_plot.title(),
    plot.subtitle = rc_txtbox_plot.subtitle(),    
    axis.text.x = element_text(color = rc_axis_tick_txt_color),
    axis.text.y = element_text(color = rc_axis_tick_txt_color)  
  ) +
  # remove any scale expansion
  scale_x_continuous(expand = c(0,0), name = "", breaks = seq(2016, 2022, 2)) +
  # have y scale not start at 0, add unit % 
  scale_y_continuous(expand = c(0,0), name = "", 
                     labels = function(x) paste0(x, "%"))+
  scale_color_ipsum() +
  scale_fill_ipsum() +
  labs(
    title="Une majorité de personnes connaissent une amélioration de leur situation professionnelle avec la migration",
    subtitle="Avec la migration, la situation professionnelle s'est:")

wcond_area
# annot_df <- tibble(
#   year = rep(2019, 3),
#   share_w = c(27, 72, 93),
#   txt = c("Tertiaire", "Secondaire II", "Secondaire I")
# )
# 
# edu_chart1_a <- flush_ticks(edu_chart1)  +
#   geom_richtext(data = annot_df, aes(x = year, y = share_w, label = txt, group = 1),
#                 fill = NA, label.color = NA,# remove background and outline,
#                 color = "white", size = 5,
#                 fontface = "bold",
#                 hjust = 0.5, family = font_rc
#   )


```
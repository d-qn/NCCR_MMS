---
title: "MMS_NCCR_template"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

```{r setup & load data, include=FALSE}
source("Scripts/_helpers.R")
run_n_check <- T
```


```{r wrangle}
c2t_A1 <- read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
c2t_B1 <- read_csv(here("Data", "code2txt", "NCCR_MMS_codes - B1.csv"))
c2t_E38 <- read_csv(here("Data", "code2txt", "NCCR_MMS_codes - E38.csv"))



data_all <- mms_df  %>% 
  ### subset !!!
  left_join(c2t_A1) %>% 
  left_join(c2t_B1) %>% 
  left_join(c2t_E38 %>% select(-edu_details)) %>% 
  mutate(
    migy = mms_encode_migration_year(A6,year)
  ) %>% 
  left_join(
    migy2yearIntervals) 
  # select(
  #   A1, A6, B1, B9, E38, year, weight, everything()
  # )  
    
d_df <- data_all %>% 
  select(year:mig_4y)

```


```{r wrangle & check}
# 1 by years since 2018
ints_df <- d_df %>% 
  filter(year >= 2018) %>% 
  filter(!is.na(groupe_job_edu)) %>% 
  group_by(year, groupe_job_edu) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(year) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(year, groupe_job_edu, share, n_y,n, weight) %>% 
  # create coords for donut chart https://r-graph-gallery.com/128-ring-or-donut-plot.html
  group_by(year) %>% 
  mutate(
    ymax = cumsum(share),
    ymin = c(0, head(ymax, n=-1)),
    # Compute label position
    label_pos = (ymax + ymin) / 2,
    # Compute a good label
    label = paste0(share, "%")
  ) %>% 
  ungroup()


if(run_n_check) {
  ints_df %>% 
    select(year, n_y, groupe_job_edu, share) %>%
    pivot_wider(
      names_from = groupe_job_edu,
      values_from = share
    ) 
}

# 2 by 4 years migration intervals 
ints_migy_df <- d_df %>%
  filter(!is.na(mig_4y)) %>%
  filter(!is.na(groupe_job_edu)) %>%
  group_by(mig_4y, groupe_job_edu) %>%
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(mig_4y) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(mig_4y, groupe_job_edu, share, n_y,n, weight) 

if(run_n_check) {
  ints_migy_df %>% 
    select(mig_4y, n_y, groupe_job_edu, share) %>%
    pivot_wider(
      names_from = groupe_job_edu,
      values_from = share
    )
}

# 3. By country
ints_pays_df <- d_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(country)) %>% 
  filter(!is.na(groupe_job_edu)) %>% 
  group_by(country, groupe_job_edu) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
    #share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  group_by(country) %>% 
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = round(weight/sum(weight, na.rm = TRUE)*100, 1)
  ) %>% 
  ungroup() %>% 
  select(country, groupe_job_edu, share, n_y,n, weight) %>% 
  mutate(
    country = fct_reorder(country, share, .fun = max, .desc = T)
  ) %>% 
  arrange(country, desc(share))

if(run_n_check) {
  ints_pays_df %>% 
    select(country, n_y, groupe_job_edu, share) %>%
    pivot_wider(
      names_from = groupe_job_edu,
      values_from = share
    )
}
```

### Viz 

#### 1. 
```{r main chart}
# faceted pie donut chart by year
ints_df %>% 
 ggplot(
   aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=groupe_job_edu)) +
  geom_rect(color = "white") +
  geom_label(
    x=3.5, aes(y=label_pos, label=label), size=3,
    fill = NA, label.size = 0, 
    color = "white", 
    family = mms_base_family) +
  facet_wrap(~year) +
  coord_polar(theta="y") + # Try to remove that to understand how the chart is built initially
 # 
  #theme_void() +
  theme_mms(
    grid=F, 
    axis=F,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 3),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
  ) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "none",
       #panel.spacing = unit(-50, "cm"),
    panel.spacing.y = unit(-10, "pt"),  # reduce space between facets
    strip.text = element_text(angle = 0, hjust = 0.5,
                              # remove margin
                              margin = margin(b = 0, t = 10))# 0 = left,
  ) +
  scale_fill_manual(values = nccr_categorical()[c(7,11)]) +
  scale_y_continuous(name = "", expand = c(0, 0)) +
  scale_x_continuous(name = "", expand = c(0, 0), limits = c(2, 4)) +
  labs(
    title = "Most people consider their education suited to their job, with little change over time",
    subtitle = "Share of people who consider their education suited to their job, by year since 2018"
  )





# ints_df %>% 
#   filter(year >= 2018) %>% 
#   ggplot(aes(x = "", y = share, fill = groupe_job_edu)) +
#   geom_bar(stat = "identity", width = 1, color = "white") +
#   coord_polar(theta = "y") +
#   facet_wrap(~year) +
#   labs(
#     title = "Part des groupes d'emploi-études dans la population active",
#     subtitle = "Années depuis 2018",
#     fill = "Groupe emploi-études"
#   ) +
#   #theme_void() +
#   theme_mms(
#     grid=F, 
#     axis=F,
#     mms_plot_title = mms_txtbox_plot.title(nrow_txt = 3),
#     mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 2)
#   )



```
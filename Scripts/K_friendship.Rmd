---
title: "K Friendship"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

```{r setup & load data, include=FALSE}
source("_helpers.R")
run_n_check <- T
```


```{r load}
# pays 
c2t_B1 <- read_csv(here("Data", "code2txt", "NCCR_MMS_codes - B1.csv"))


# h162f <- tibble(
#   H16 = c(1,2,3,4),
#   h16 = c("Leave", "Leave", "Stay", "Don't know")   
# ) %>% 
#   mutate(
#     h16 = factor(h16, levels = c("Leave",  "Don't know", "Stay"))
#   )
# data_all <- mms_df %>% 
#   left_join(h162f, by = c("H16")) %>%
#   left_join(c2t_B1) 
g62f <- tibble(
  G6 = 1:5,
  g6 = c(rep("(Mostly) in Switzerland", 2), "Mixed", rep("(Mostly) abroad", 2))
)
g202f <-  tibble(
  G20 = 1:2,
  g20 = c("Yes", "No")
)

data_all <- mms_df %>% 
  mutate(migy = mms_encode_migration_year(A6,year)) %>% 
  left_join(g62f, by = c("G6")) %>%
  left_join(g202f, by = c("G20")) %>%
  left_join(migy2yearIntervals) %>%
  left_join(c2t_B1) 


k_df <- data_all %>% 
  select(year:country) 

```

### Wrangle & check

```{r wrangle & check}
fri_df <- k_df %>% 
  filter(year > 2016) %>%
  filter(!is.na(g6)) %>% 
  group_by(year, g6) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(year) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>%
  ungroup() %>% 
  mutate(
    g6 = factor(g6, levels = g62f$g6[c(1,3,5)])
  )

if(run_n_check) {
  fri_df %>% 
    select(year, g6, share, n_y) %>%
    pivot_wider(
      names_from = g6,
      values_from = share
    )
}

frim_df <- k_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(g6)) %>% 
  filter(!is.na(mig_4y)) %>% 
  group_by(mig_4y, g6) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(mig_4y) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>%
  ungroup()

if(run_n_check) {
  frim_df %>% 
    select(mig_4y, g6, share, n_y) %>%
    pivot_wider(
      names_from = g6,
      values_from = share
    )
}

# by country
fric_df <- k_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(g6)) %>% 
  filter(!is.na(country)) %>% 
  group_by(country, g6) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(country) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>%
  ungroup() %>% 
  filter(country != "Other countries") 

# Create a helper data frame with just the sorting values
country_order_df <- fric_df %>%
  filter(g6 == g62f$g6[1]) %>%
  select(country, sorting_value = share)

# Join the sorting values back and then reorder the factor
fric_df %<>%
  mutate(
    country = factor(
      country, levels = country_order_df$country)
  )

if(run_n_check) {
  fric_df %>% 
    select(country, g6, share, n_y) %>%
    pivot_wider(
      names_from = g6,
      values_from = share
    )
}

# by g20 and mig_4y
frimg_df <- k_df %>% 
  filter(year == 2024) %>% 
  filter(!is.na(g20)) %>% 
  filter(!is.na(mig_4y)) %>% 
  group_by(mig_4y, g20) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(mig_4y) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>%
  ungroup()

if(run_n_check) {
  frimg_df %>% 
    select(mig_4y, g20, share, n_y) %>%
    pivot_wider(
      names_from = g20,
      values_from = share
    )
}
```



### VIZ

#### 1. main  chart

```{r 1}


#  annot_df <- tibble(
#    year = rep(2021, 3),
#    share_w = c(28, 66, 92),
#    txt = c("Stay", "Don't know", "Leave")
#  )  
# 
# 
# p_sl_1 <- sl_df %>% 
#   ggplot(aes(x = year, y = share, group = h16)) +
#   geom_area(
#     aes(fill = h16), 
#     alpha = 1) +
#   theme_mms(
#     grid="XY", axis="XY", 
#    # grid_col =  scales::alpha("lightgrey", 0.6),
#     #  plot_margin = mms_plot_margin_l,
#     mms_plot_title = mms_txtbox_plot.title(nrow_txt = 4),
#     mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 4)
#   )  +
#   theme(legend.position = "none",
#         panel.background = element_rect(fill = NA),  # transparent
#         panel.ontop = TRUE
#   ) +
#   # remove any scale expansion  
#   scale_x_continuous(expand = c(0,0), name = "", 
#                      breaks = seq(2018, 2024, 2)) +
#   # have y scale not start at 0, add unit %
#   scale_y_continuous(expand = c(0,0), name = "", 
#                      breaks = seq(25, 100, 25),
#                      labels = function(x) paste0(x, "%")) +
#   labs(
#     title = str_c("More people are planning to ","<span style='color:",
#         nccr_bi_colors[6], 
#         ";'>stay</span> ", "in Switzerland"),
#     subtitle = str_c(
#       "Share of respondents intending to ",
#       "<span style='color:", nccr_bi_colors[6], ";'>stay</span> in Switzerland, ", 
#        "<span style='color:", nccr_bi_colors[8], ";'>leave</span> or who are ",      
#       "<span style='color:", nccr_bi_colors[14], ";'>undecided</span>, ",      
#       " by survey year"
#     )) +
#   scale_fill_manual(values =nccr_bi_colors[c(8,13,6)]) +
#   geom_richtext(data = annot_df, aes(
#     x = year, y = share_w, label = txt, group = 1),
#     fill = NA, label.color = NA,# remove background and outline,
#     color = "white", size = 7, alpha = 1,
#     #fontface = "bold",
#     hjust = 0.5, family = mms_base_family
#   )
# 
# p_sl_1

annot_df <- tibble(
  year = rep(2021, 3),
  share_w = c(28, 66, 92),
  txt = g62f$g6[rev(c(1,3,5))]
)

p_fri_1 <- fri_df %>% 
  ggplot(aes(x = year, y = share, group = g6)) +
  geom_area(
    aes(fill = g6), 
    alpha = 1) +
  theme_mms(
    grid="XY", axis="XY", 
   # grid_col =  scales::alpha("lightgrey", 0.6),
     plot_margin = mms_plot_margin_l,
    mms_plot_title = mms_txtbox_plot.title(nrow_txt = 4),
    mms_plot_subtitle = mms_txtbox_plot.subtitle(nrow_txt = 4)
  )  +
  theme(legend.position = "none",
        panel.background = element_rect(fill = NA),  # transparent
        panel.ontop = TRUE
  ) +
  # remove any scale expansion  
  scale_x_continuous(expand = c(0,0), name = "", 
                     breaks = seq(2018, 2024, 2)) +
  # have y scale not start at 0, add unit %
  scale_y_continuous(expand = c(0,0), name = "", 
                     breaks = seq(0, 100, 20),
                     labels = function(x) paste0(x, "%")) +
  labs(
    title = str_c("Most migrants make friends ","<span style='color:",
        nccr_bi_colors[6], 
        ";'>(mostly)</span> ", "in Switzerland"),
    subtitle = str_c(
      "Share of respondents who made friends ",
      "<span style='color:", nccr_bi_colors[6], ";'>(mostly)</span> in Switzerland, ", 
       "<span style='color:", nccr_bi_colors[10], ";'>mixed</span> or ",      
      "<span style='color:", nccr_bi_colors[8], ";'>(mostly)</span> abroad, ",      
      " by survey year"
    )) +
  scale_fill_manual(values =nccr_bi_colors[c(6,10,8)]) +
  geom_richtext(data = annot_df, aes(
    x = year, y = share_w, label = txt, group = 1),
    fill = NA, label.color = NA,# remove background and outline,
    color = "white", size = 5, alpha = 1,
    #fontface = "bold",
    hjust = 0.5, family = mms_base_family
  )

p_fri_1
```

#### 2.   

```{r 2}

```

#### 3.

```{r 3}
```

#### patch

```{r patch}

mms_export_vector(
  plot = patchwork,
  filepath = #here("Output", "charts", ""),
  bg_col = pw_bg_color
  )


```
---
title: "MMS_NCCR_template"
author: "Duc-Quang Nguyen"
date: "2025-05-10"
output: html_document
---

```{r setup & load data, include=FALSE}
source("_helpers.R")
run_n_check <- T
```


```{r load}
# gender
c2t_A1 <- read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
# pays 
c2t_B1 <- read_csv(here("Data", "code2txt", "NCCR_MMS_codes - B1.csv"))

c3 <- mms_load_data(F) %>% 
  select(C3_1:C3_9)

c1_codes <- tibble(
 C1 = c(1, 2, 3, 4, 5, 6, 7),
 nat = c("yes", "yes", "no", "no", "don't know", "yes", "yes")
)

data_all <- bind_cols(mms_df, c3)  %>%  
  # hack in 2024 C1 column is named c1
  mutate(
    C1 = ifelse(year == 2024, c1, C1)
  ) %>% 
  left_join(
    c1_codes, by = "C1"
  ) %>% 
  left_join(c2t_A1) %>% 
  left_join(c2t_B1) %>% 
  mutate_at(vars(C3_1:C3_9), ~ case_when(
    . == 1 ~ "yes",
    . == 2 ~ "no",
    TRUE ~ NA_character_
  )) %>% 
  mutate(  
    migy = mms_encode_migration_year(A6,year)
  ) %>% 
  left_join(
    migy2yearIntervals
  )

h_df <- data_all %>% 
  select(year:mig_4y)
```


```{r wrangle & check}
nati_y_df <- h_df %>% 
  filter(year > 2016) %>% 
  filter(!is.na(nat)) %>%
  filter(!is.na(year)) %>%
  group_by(year, nat) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(year) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>% 
  ungroup() 

  
  
if(run_n_check) {
  nati_y_df %>% 
    select(year, nat, share, n_y) %>%
    pivot_wider(
      names_from = nat,
      values_from = share
    )
}


### manual data 
nati_migy_df  <- tibble(
  yeari = rep(c("2010-2014", "2006-2009"), 5),
  year = rep(c(2024, 2022, 2020, 2018, 2015), each = 2),
  share = c(70.9, 78.2, 67.1, 74.3, 61.7, 68.7, 53.2, 62.1, 38.9, 45.3)
)

if(run_n_check) {
  nati_migy_df %>% 
    select(year, yeari, share) %>% 
    pivot_wider(
      names_from = yeari,
      values_from = share
    )
}


nati_c_df <- h_df %>% 
  filter(!is.na(nat)) %>% 
  filter(!is.na(country)) %>% 
  group_by(country, year, nat) %>% 
  reframe(
    n = n(),
    weight = sum(weight, na.rm = TRUE)
  ) %>%
  group_by(country, year) %>%
  mutate(
    n_y = sum(n, na.rm = TRUE),
    share = weight/sum(weight, na.rm = TRUE)*100
  ) %>% 
  ungroup() %>% 
  filter(nat == "yes")

if(run_n_check) {
  nati_c_df %>% 
    select(country, year, share) %>%
    pivot_wider(
      names_from = year,
      values_from = share
    )
}


if(run_n_check) {
  
}
```



### VIZ

#### 1. main  chart

```{r 1}

```

#### 2.   

```{r 2}

```

#### 3.

```{r 3}
```

#### patch

```{r patch}

mms_export_vector(
  plot = patchwork,
  filepath = #here("Output", "charts", ""),
  bg_col = pw_bg_color
  )


```
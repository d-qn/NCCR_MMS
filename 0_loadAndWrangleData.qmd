---
title: "NCCR MMS"
author: "Duc-Quang Nguyen "
date: last-modified
editor: visual
execute: 
  cache: true
highlight-style: pygments
format:
  html: 
    code-fold: true
    echo: TRUE
    warning: FALSE
    message: FALSE
    html-math-method: katex
    toc: true
    toc_depth: 3
    toc_float: true
    theme: simplex
---


```{r}
#| label: setup
#| include: false
  
library(here)
library(tidyverse)
library(magrittr)
library(stringr)
library(knitr)
library(dqnTheme)
library(hrbrthemes)
library(skimr)

Sys.setlocale("LC_TIME", "fr_FR.UTF-8")
dqnTheme::update_geom_font_defaults()
options(scipen=999)
options(dplyr.summarise.inform = FALSE)

library(paletteer)
library(stevethemes)

### Interactive
library(patchwork)
library(ggtext)
library(ggforce)
library(directlabels)
library(geomtextpath)

```

## 1a. Load and merge data files

```{r}
#| label: load and merge data files
#| include: false
#| 
data_file_path <- list.files(
  here("Data"), 
  pattern = ".csv", 
  full.names = T)

# read csv files
data_read <- data_file_path %>% 
  map_df(function(ff) {
    rr <- read_delim(ff, delim  = ";")
    year <- colnames(rr)[ncol(rr)] %>% 
      str_extract( "\\d+") %>% as.numeric()
    
    codes <- colnames(rr)[-ncol(rr)] %>% str_sub_all(4) %>% 
      unlist()
    
    colnames(rr) <- c(codes, "weight")
    rr %>% 
      mutate(year = year)
  }) 

  
data_read %<>% 
  select(
    A1, A6, B1, B9, D1, E38, year, weight, everything()
  ) %>% 
  write_csv(here("Output", "data", "merged_data_files.csv"))

```

## 1b. Enrich & wrangle

```{r}
#| label: join code txt to data

c2t_A1 <- read_csv(here("Data", "code2txt", "NCCR MMS Codes A1.csv"))
c2t_B1 <- read_csv(here("Data", "code2txt", "NCCR MMS Codes B1.csv"))
c2t_D1 <- read_csv(here("Data", "code2txt", "NCCR MMS Codes D1.csv"))
c2t_E38 <- read_csv(here("Data", "code2txt", "NCCR MMS Codes E38.csv"))


data_all <- data_read %>% 
  left_join(c2t_A1) %>% 
  left_join(c2t_B1) %>% 
  left_join(c2t_D1) %>% 
  left_join(c2t_E38)


data_all %>% filter(is.na(pays)) %>% .$B1 %>% unique() %>% sort()

data_all %>% 
  group_by(year, groupe_edu) %>% 
  summarise(
    tot = sum(weight, na.rm = T)
  ) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(
    toty = sum(tot)
  ) %>% 
  ungroup %>% 
  mutate(
    share = tot/toty
  )
  


# summary_tb %>%
#   select(-weight_sum) %>%
#   mutate(share = round(share, 1)) %>% 
#   mutate(share_w = round(share_w, 1)) %>% 
#   select(-tot_weight) %>% 
#   rename( N_year = toty, perc = share, perc_weighted = share_w) %>% 
#   write_csv("~/Desktop/summaryQ_NCCR_MMS.csv")


```

## VIZ 

### Education history and current situation

```{r}
edu_main <- data_all %>% 
  group_by(year, groupe_edu) %>% 
  summarise(
    n = n(),
    weight_sum = sum(weight)
  ) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(
    toty = sum(n),
    tot_weight = sum(weight_sum)
  ) %>% 
  ungroup %>% 
  mutate(
    share_w = (weight_sum /tot_weight) * 100
  ) 

edu_genre <- data_all %>% 
  group_by(year, groupe_edu, sexe) %>% 
  summarise(
    n = n(),
    weight_sum = sum(weight)
  ) %>% 
  ungroup() %>% 
  group_by(year, sexe) %>% 
  mutate(
    toty = sum(n),
    tot_weight = sum(weight_sum)
  ) %>% 
  ungroup %>% 
  mutate(
    share_w = (weight_sum /tot_weight) * 100
  ) 

edu3_pays <- data_all %>% 
  group_by(year, groupe_edu, pays) %>% 
  summarise(
    n = n(),
    weight_sum = sum(weight)
  ) %>% 
  ungroup() %>% 
  group_by(year, pays) %>% 
  mutate(
    toty = sum(n),
    tot_weight = sum(weight_sum)
  ) %>% 
  ungroup %>% 
  mutate(
    share_w = (weight_sum /tot_weight) * 100
  ) %>% 
  filter(groupe_edu == "Tertiaire")

# du3_pays %>% filter(year == 2022) %>% arrange(desc(share_w))



edu_chart1 <- edu_main %>% 
  ggplot(aes(x = year, y = share_w, group = groupe_edu)) +
  geom_area(aes(fill = groupe_edu), alpha = 0.9) + 
  theme_ipsum_rc(grid="XY", axis="xy", grid_col = "darkgrey") + 
  theme(panel.ontop = TRUE, legend.position = "none") +
  # remove any scale expansion
  scale_x_continuous(expand = c(0,0), name = "") +
  # have y scale not start at 0, add unit % 
  scale_y_continuous(expand = c(0,0), name = "", 
                     labels = function(x) paste0(x, "%"))+
  scale_color_ipsum() +
  scale_fill_ipsum() +
  labs(
       title="La migration est de plus en plus hautement qualifiée",
       subtitle="Le plus niveau de formation atteint parmi les répondant-e-s à l’enquête, en %")

annot_df <- tibble(
  year = rep(2021.5, 3),
  share_w = c(27, 72, 95),
  txt = c("Tertiaire", "Secondaire II", "Secondaire I")
)

edu_chart1_a <- flush_ticks(edu_chart1)  +
  geom_richtext(data = annot_df, aes(x = year, y = share_w, label = txt, group = 1),
                fill = NA, label.color = NA,# remove background and outline,
                color = "white", size = 7,
                hjust = 1, family = font_rc
                )
  

edu_chart1_a 

# edu_chart1_a + 
#   facet_zoom(y = group_edu == "Tertiaire", split = T)

# edu_chart1_a +
#   facet_zoom(ylim = c(50, 60),
#              split = T,
#              zoom.size=1,
#              show.area = TRUE,
#              horizontal = TRUE)


edu_all_genre <- bind_rows(
  edu_main %>% 
    select(year, groupe_edu, share_w, n) %>% 
    mutate(type = "all"),
  edu_genre %>% 
    select(year, sexe, groupe_edu, share_w, n) %>% 
    rename(type = sexe)
) %>%  
  filter(groupe_edu == "Tertiaire")

edu_genre_rib_df <- edu_all_genre %>% 
  filter(type %in% c("male", "female") & 
           groupe_edu == "Tertiaire") %>% 
  select(year, share_w, type) %>% 
  pivot_wider(names_from = type, values_from = share_w)

edu_chart2 <- edu_all_genre %>% 
  mutate(
    type = case_when(
      type == "all" ~ "TOTAL",
      type == "male" ~ "Hommes",
      type == "female" ~ "Femmes",
      T ~ type
    )
  ) %>% 
  ggplot(aes(x= year)) +
  geom_ribbon(
    data = edu_genre_rib_df,
    aes(ymin = male, ymax = female, group = 1),
    fill = "grey70", alpha = 0.2) +
  geom_point(aes(x = year, y = share_w, group = type,
                 color = type), size = 2,
             alpha = 0.6) +
  geom_line(aes(x = year, y = share_w, group = type,
    color = type, size = n), lineend="round", alpha= 0.8) +
  theme_ipsum_rc(axis="xy", grid = FALSE) + 

  theme(panel.ontop = TRUE, legend.position = "none") +
  scale_size(range = c(0.1, 2)) +
   scale_x_continuous(
     breaks = 2016:2024,
    # limits = c(2016,2024),
     expand = c(0.01,0), name = "") +
  # have y scale not start at 0, add unit % 
  scale_y_continuous(expand = c(0.005,0.01), name = "", 
                     labels = function(x) paste0(x, "%")) +
  scale_colour_manual(
    values=c("#7725eb", "#469b88", "#262626")) +
  geom_text(data=. %>% 
              arrange(desc(year)) %>% 
              group_by(type) %>% 
              slice(1), 
            aes(label=type, y = share_w,
                colour = type), 
            family = font_rc,
            position=position_nudge(0.07), hjust=0, show.legend=FALSE, size = 5) +
  coord_cartesian(xlim = c(2016, 2022.9)) 

edu_chart2

edu_chart1_a + edu_chart2


edu3_pays_df <- edu3_pays %>%
  select(year, pays, groupe_edu, share_w, n) %>%
  rename(type = pays) %>% 
  filter(year == 2022) %>% 
  arrange(desc(share_w)) %>% 
  select(type, share_w, n)

```